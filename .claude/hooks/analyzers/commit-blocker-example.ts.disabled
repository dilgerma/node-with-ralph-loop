#!/usr/bin/env node

/**
 * Example Analyzer: Commit Blocker
 *
 * This analyzer demonstrates how to BLOCK commits based on specific conditions.
 * It's disabled by default (note the .disabled extension).
 *
 * To enable: Rename to commit-blocker-example.ts
 */

import { readFileSync } from 'fs';

interface HookData {
  event: string;
  timestamp: string;
  repository: string;
  branch: string;
  staged_diff: string;
  unstaged_diff: string;
  changed_files: string[];
  stats: {
    staged_files: number;
    has_staged_changes: boolean;
    has_unstaged_changes: boolean;
  };
}

interface AnalyzerResult {
  approved: boolean;
  reason?: string;
}

async function main() {
  try {
    // Read JSON data from stdin
    const input = readFileSync(0, 'utf-8');
    const data: HookData = JSON.parse(input);

    console.log('üö´ Commit Blocker Example:');

    // Example 1: Block commits to main branch
    if (data.branch === 'main') {
      const result: AnalyzerResult = {
        approved: false,
        reason: 'Direct commits to main branch are not allowed'
      };
      console.log('\n' + JSON.stringify(result));
      return;
    }

    // Example 2: Block commits with too many files
    const MAX_FILES = 50;
    if (data.changed_files.length > MAX_FILES) {
      const result: AnalyzerResult = {
        approved: false,
        reason: `Too many files changed (${data.changed_files.length} > ${MAX_FILES}) - split into smaller commits`
      };
      console.log('\n' + JSON.stringify(result));
      return;
    }

    // Example 3: Block if critical files changed without tests
    const criticalFiles = data.changed_files.filter(f =>
      f.includes('/api/') ||
      f.includes('/core/') ||
      f.endsWith('Handler.ts')
    );

    const testFiles = data.changed_files.filter(f => f.endsWith('.test.ts'));

    if (criticalFiles.length > 0 && testFiles.length === 0) {
      const result: AnalyzerResult = {
        approved: false,
        reason: 'Critical files changed but no test files updated - add tests first'
      };
      console.log(`\n   Critical files: ${criticalFiles.join(', ')}`);
      console.log('\n' + JSON.stringify(result));
      return;
    }

    // Example 4: Block if package.json changed without package-lock.json
    const packageJsonChanged = data.changed_files.includes('package.json');
    const lockfileChanged = data.changed_files.includes('package-lock.json');

    if (packageJsonChanged && !lockfileChanged) {
      const result: AnalyzerResult = {
        approved: false,
        reason: 'package.json changed but package-lock.json not updated - run npm install'
      };
      console.log('\n' + JSON.stringify(result));
      return;
    }

    // All checks passed
    console.log('   ‚úÖ All blocking checks passed');
    const result: AnalyzerResult = {
      approved: true,
      reason: 'No blocking issues found'
    };
    console.log('\n' + JSON.stringify(result));

  } catch (error) {
    console.error('‚ùå Error in commit blocker:', error);
    console.log(JSON.stringify({ approved: true, reason: 'analyzer_error' }));
    process.exit(1);
  }
}

main();
